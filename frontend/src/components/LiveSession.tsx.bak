import { useEffect, useMemo, useRef, useState } from 'react';
import { Play, Square, RefreshCcw, Video, VideoOff } from 'lucide-react';
import { API_BASE_URL } from '../config/constants';
import { Card, CardContent, CardHeader, CardTitle } from './ui/card';
import { Badge } from './ui/badge';
import { Button } from './ui/button';
import { Progress } from './ui/progress';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from './ui/select';

const DEFAULT_METRICS = {
  postureScore: 0,
  alignment: '-',
  rangeOfMotion: 0,
  formQuality: '-',
};

const EXERCISE_OPTIONS = [
  { value: 'shoulder_rotation', label: 'Shoulder Rotation' },
  { value: 'squat', label: 'Squat' },
] as const;

type Metrics = typeof DEFAULT_METRICS;
type ExerciseOption = (typeof EXERCISE_OPTIONS)[number]['value'];

type StatusEvent = {
  message?: string;
  level?: 'error' | 'info';
  code?: number;
};

type VideoDevice = {
  deviceId: string;
  label: string;
  index: number;
};

export function LiveSession() {
  const [metrics, setMetrics] = useState<Metrics>(DEFAULT_METRICS);
  const [exercise, setExercise] = useState<ExerciseOption>('shoulder_rotation');
  const [statusMessage, setStatusMessage] = useState('');
  const [isSessionActive, setIsSessionActive] = useState(false);
  const [isPreviewActive, setIsPreviewActive] = useState(false);
  const [devices, setDevices] = useState<VideoDevice[]>([]);
  const [selectedDeviceId, setSelectedDeviceId] = useState<string>('');
  const [selectedCameraIndex, setSelectedCameraIndex] = useState<string>('0');

  const eventSourceRef = useRef<EventSource | null>(null);
  const videoRef = useRef<HTMLVideoElement>(null);
  const [previewStream, setPreviewStream] = useState<MediaStream | null>(null);

  useEffect(() => {
    refreshDevices();
  }, []);


  useEffect(() => {
    return () => {
      eventSourceRef.current?.close();
      stopPreview();
    };
  }, []);

  useEffect(() => {
    const video = videoRef.current;
    if (!video) return;
    if (previewStream) {
      video.srcObject = previewStream;
      video.muted = true;
      video.playsInline = true;
      const playPromise = video.play();
      if (playPromise) {
        playPromise.catch(() => {
          /* autoplay may require user gesture */
        });
      }
    } else {
      video.srcObject = null;
    }
  }, [previewStream]);

  const refreshDevices = async () => {
    try {
      const devicesList = await navigator.mediaDevices.enumerateDevices();
      const videoInputs = devicesList
        .filter((device) => device.kind === 'videoinput')
        .map((device, index) => ({
          deviceId: device.deviceId,
          label: device.label || `Camera ${index + 1}`,
          index,
        }));

      setDevices(videoInputs);
      if (videoInputs.length) {
        setSelectedDeviceId(videoInputs[0].deviceId);
        setSelectedCameraIndex(String(videoInputs[0].index));
      }
    } catch (error) {
      console.error('Failed to enumerate devices', error);
      setStatusMessage('Unable to access cameras. Check permissions.');
    }
  };

  const startPreview = async () => {
    if (!selectedDeviceId) {
      setStatusMessage('Select a camera before starting the preview.');
      return;
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: { exact: selectedDeviceId } },
        audio: false,
      });
      setPreviewStream(stream);
      setIsPreviewActive(true);
      setStatusMessage('Preview running. When ready, click Start Analysis.');
    } catch (error) {
      console.error('Unable to start preview', error);
      setStatusMessage('Preview failed. Make sure the camera is not in use by another app.');
    }
  };

  const stopPreview = () => {
    if (previewStream) {
      previewStream.getTracks().forEach((track) => track.stop());
    }
    setPreviewStream(null);
    if (videoRef.current) {
      videoRef.current.srcObject = null;
    }
    setIsPreviewActive(false);
  };

  const startSession = () => {
    if (eventSourceRef.current) {
      eventSourceRef.current.close();
      eventSourceRef.current = null;
    }

    const url = new URL(`${API_BASE_URL}/sessions/start`);
    url.searchParams.set('exercise', exercise);
    url.searchParams.set('camera', selectedCameraIndex);

    const source = new EventSource(url.toString());

    source.addEventListener('status', (event) => {
      const data = JSON.parse((event as MessageEvent<string>).data) as StatusEvent;
      if (data.level === 'error') {
        setStatusMessage(`⚠️ ${data.message ?? 'Session error'}`);
        setIsSessionActive(false);
        return;
      }
      if (data.message) {
        setStatusMessage(data.message);
      }
      if (data.code !== undefined) {
        setIsSessionActive(false);
      }
    });

    source.addEventListener('metrics', (event) => {
      const data = JSON.parse((event as MessageEvent<string>).data);
      console.debug('metrics event', data);
      setMetrics({
        postureScore: typeof data.posture_score === 'number' ? data.posture_score : 0,
        alignment: data.alignment ?? '-',
        rangeOfMotion: typeof data.range_of_motion === 'number' ? data.range_of_motion : 0,
        formQuality: data.form_quality ?? '-',
      });
    });

    source.onerror = () => {
      setStatusMessage('Connection lost. Please restart the session.');
      setIsSessionActive(false);
      source.close();
      eventSourceRef.current = null;
    };

    eventSourceRef.current = source;
    setMetrics(DEFAULT_METRICS);
    setIsSessionActive(true);
  };

  const endSession = () => {
    if (eventSourceRef.current) {
      eventSourceRef.current.close();
      eventSourceRef.current = null;
    }
    setIsSessionActive(false);
    setStatusMessage('Session ended.');
  };

  const deviceOptions = useMemo(() => {
    return devices.map((device) => ({
      value: device.deviceId,
      label: `${device.label} (cv2 index ${device.index})`,
      indexValue: String(device.index),
    }));
  }, [devices]);

  return (
    <div className="space-y-6 max-w-7xl">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-[#2C2E6F] mb-2">Live Exercise Session</h1>
          <p className="text-gray-600">Use your OBS Virtual Camera (or other webcam) for live pose analysis.</p>
        </div>
        <Badge className="bg-gradient-to-r from-[#2C2E6F] to-[#4DD2C1] text-white px-4 py-2">
          OBS Workflow
        </Badge>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <Card className="lg:col-span-2 border-0 shadow-xl">
          <CardContent className="p-6 space-y-4">
            <div className="relative bg-slate-900 rounded-2xl overflow-hidden aspect-video flex items-center justify-center text-slate-300">
              {isPreviewActive && previewStream ? (
                <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover" />
              ) : (
                <div className="text-center space-y-3">
                  <VideoOff className="w-12 h-12 mx-auto text-[#4DD2C1]" />
                  <p className="text-lg">Start the preview to verify your OBS feed.</p>
                  <p className="text-sm text-slate-400">Select the virtual camera and click “Start Preview”.</p>
                </div>
              )}
            </div>

            <div className="grid gap-4 md:grid-cols-3 md:items-center bg-[#E9E6F9] rounded-xl p-4">
              <div className="space-y-2">
                <p className="text-xs text-gray-500 uppercase tracking-wide">Camera</p>
                <Select
                  value={selectedDeviceId}
                  onValueChange={(value) => {
                    setSelectedDeviceId(value);
                    const option = deviceOptions.find((item) => item.value === value);
                    if (option) {
                      setSelectedCameraIndex(option.indexValue);
                    }
                  }}
                >
                  <SelectTrigger className="w-full bg-white">
                    <SelectValue placeholder="Select camera" />
                  </SelectTrigger>
                  <SelectContent>
                    {deviceOptions.map((device) => (
                      <SelectItem key={device.value} value={device.value}>
                        {device.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <p className="text-xs text-gray-500 uppercase tracking-wide">Exercise</p>
                <Select value={exercise} onValueChange={(value) => setExercise(value as ExerciseOption)}>
                  <SelectTrigger className="w-full bg-white">
                    <SelectValue placeholder="Select exercise" />
                  </SelectTrigger>
                  <SelectContent>
                    {EXERCISE_OPTIONS.map((option) => (
                      <SelectItem key={option.value} value={option.value}>
                        {option.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2 text-sm text-gray-600">
                <p className="font-medium text-[#2C2E6F]">Quick Steps</p>
                <ol className="list-decimal list-inside space-y-1">
                  <li>Open OBS Camera on your phone.</li>
                  <li>Choose “OBS Virtual Camera” above & start preview.</li>
                  <li>Click “Start Analysis” to stream metrics from Python.</li>
                </ol>
              </div>
            </div>

            <div className="flex flex-wrap gap-3">
              <Button variant="secondary" onClick={refreshDevices} className="h-12">
                <RefreshCcw className="w-4 h-4 mr-2" /> Refresh Cameras
              </Button>
              <Button onClick={isPreviewActive ? stopPreview : startPreview} className="h-12">
                {isPreviewActive ? (
                  <>
                    <VideoOff className="w-4 h-4 mr-2" /> Stop Preview
                  </>
                ) : (
                  <>
                    <Video className="w-4 h-4 mr-2" /> Start Preview
                  </>
                )}
              </Button>
              {!isSessionActive ? (
                <Button onClick={startSession} className="flex-1 bg-gradient-to-r from-[#4DD2C1] to-[#3bc1b0] h-12">
                  <Play className="w-5 h-5 mr-2" /> Start Analysis
                </Button>
              ) : (
                <Button onClick={endSession} variant="destructive" className="flex-1 h-12 bg-[#FF8A73]">
                  <Square className="w-5 h-5 mr-2" /> End Analysis
                </Button>
              )}
            </div>

            {statusMessage && (
              <div className="text-sm text-gray-500 bg-white border border-dashed border-[#4DD2C1]/40 rounded-lg p-3">
                {statusMessage}
              </div>
            )}
          </CardContent>
        </Card>

        <Card className="border-0 shadow-xl h-fit">
          <CardHeader>
            <CardTitle className="text-[#2C2E6F]">Real-Time Metrics</CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            <div className="space-y-3">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-500">Posture Score</p>
                  <p className="text-3xl font-semibold text-[#2C2E6F]">{Math.round(metrics.postureScore)}%</p>
                </div>
                <Progress value={Math.min(100, Math.max(0, metrics.postureScore))} className="h-2" />
              </div>

              <div>
                <p className="text-sm text-gray-500">Alignment</p>
                <p className="text-lg text-[#4DD2C1]">{metrics.alignment}</p>
              </div>

              <div>
                <p className="text-sm text-gray-500">Range of Motion</p>
                <p className="text-lg text-[#2C2E6F]">{Math.round(metrics.rangeOfMotion)}°</p>
              </div>

              <div>
                <p className="text-sm text-gray-500">Form Quality</p>
                <p className="text-lg font-medium text-[#FF8A73]">{metrics.formQuality}</p>
              </div>
            </div>

            <div className="pt-4 border-t border-dashed border-[#E9E6F9] space-y-2">
              <h4 className="text-sm text-gray-500 uppercase tracking-wide">Tips</h4>
              <ul className="space-y-2 text-sm text-gray-600">
                <li>• Keep the OBS virtual camera active while analysing.</li>
                <li>• If metrics stay at 0, ensure the correct cv2 index is chosen.</li>
                <li>• Refresh cameras if you plug/unplug devices.</li>
              </ul>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
